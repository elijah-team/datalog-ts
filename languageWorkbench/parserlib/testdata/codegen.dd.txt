main :- value.
value :- (object | array | int | string | null).
int :- [[0-9], repSep([0-9], "")].
object :- ["{", repSep(keyValue, ","), "}"].
keyValue :- [string, ":", value].
array :- ["[", repSep(value, ","), "]"].
null :- "null".
string :- ["\"", repSep(stringChar, ""), "\""].
stringChar :- (^'"' | ['\\', '"']).
----
text/plain
import {textForSpan, childByName, childrenByName, RuleTree, extractRuleTree} from "./ruleTree";
import {Span, Grammar} from "./grammar";
import * as parserlib from "./parser"
export type JsonArray = {
  type: "Array";
  text: string;
  span: Span;
  value: JsonValue[];
};
export type JsonInt = {
  type: "Int";
  text: string;
  span: Span;
};
export type JsonKeyValue = {
  type: "KeyValue";
  text: string;
  span: Span;
  string: JsonString;
  value: JsonValue;
};
export type JsonMain = {
  type: "Main";
  text: string;
  span: Span;
  value: JsonValue;
};
export type JsonNull = {
  type: "Null";
  text: string;
  span: Span;
};
export type JsonObject = {
  type: "Object";
  text: string;
  span: Span;
  keyValue: JsonKeyValue[];
};
export type JsonString = {
  type: "String";
  text: string;
  span: Span;
  stringChar: JsonStringChar[];
};
export type JsonStringChar = {
  type: "StringChar";
  text: string;
  span: Span;
};
export type JsonValue = {
  type: "Value";
  text: string;
  span: Span;
  object: JsonObject;
  array: JsonArray;
  int: JsonInt;
  string: JsonString;
  null: JsonNull;
};
export function parse(input: string): JsonMain {
  const traceTree = parserlib.parse(GRAMMAR, "main", input)
  const ruleTree = extractRuleTree(traceTree)
  return extractMain(input, ruleTree)
}
function extractArray(input: string, node: RuleTree): JsonArray {
  return {
    type: "Array",
    text: textForSpan(input, node.span),
    span: node.span,
    value: childrenByName(node, "value").map(child => extractValue(input, child))
  };
}
function extractInt(input: string, node: RuleTree): JsonInt {
  return {
    type: "Int",
    text: textForSpan(input, node.span),
    span: node.span
  };
}
function extractKeyValue(input: string, node: RuleTree): JsonKeyValue {
  return {
    type: "KeyValue",
    text: textForSpan(input, node.span),
    span: node.span,
    string: extractString(input, childByName(node, "string")),
    value: extractValue(input, childByName(node, "value"))
  };
}
function extractMain(input: string, node: RuleTree): JsonMain {
  return {
    type: "Main",
    text: textForSpan(input, node.span),
    span: node.span,
    value: extractValue(input, childByName(node, "value"))
  };
}
function extractNull(input: string, node: RuleTree): JsonNull {
  return {
    type: "Null",
    text: textForSpan(input, node.span),
    span: node.span
  };
}
function extractObject(input: string, node: RuleTree): JsonObject {
  return {
    type: "Object",
    text: textForSpan(input, node.span),
    span: node.span,
    keyValue: childrenByName(node, "keyValue").map(child => extractKeyValue(input, child))
  };
}
function extractString(input: string, node: RuleTree): JsonString {
  return {
    type: "String",
    text: textForSpan(input, node.span),
    span: node.span,
    stringChar: childrenByName(node, "stringChar").map(child => extractStringChar(input, child))
  };
}
function extractStringChar(input: string, node: RuleTree): JsonStringChar {
  return {
    type: "StringChar",
    text: textForSpan(input, node.span),
    span: node.span
  };
}
function extractValue(input: string, node: RuleTree): JsonValue {
  return {
    type: "Value",
    text: textForSpan(input, node.span),
    span: node.span,
    object: extractObject(input, childByName(node, "object")),
    array: extractArray(input, childByName(node, "array")),
    int: extractInt(input, childByName(node, "int")),
    string: extractString(input, childByName(node, "string")),
    null: extractNull(input, childByName(node, "null"))
  };
}
const GRAMMAR: Grammar = {
  "main": {
    "type": "Ref",
    "rule": "value",
    "captureName": null
  },
  "value": {
    "type": "Choice",
    "choices": [
      {
        "type": "Ref",
        "rule": "object",
        "captureName": null
      },
      {
        "type": "Ref",
        "rule": "array",
        "captureName": null
      },
      {
        "type": "Ref",
        "rule": "int",
        "captureName": null
      },
      {
        "type": "Ref",
        "rule": "string",
        "captureName": null
      },
      {
        "type": "Ref",
        "rule": "null",
        "captureName": null
      }
    ]
  },
  "int": {
    "type": "Sequence",
    "items": [
      {
        "type": "Char",
        "rule": {
          "type": "Range",
          "from": "0",
          "to": "9"
        }
      },
      {
        "type": "RepSep",
        "rep": {
          "type": "Char",
          "rule": {
            "type": "Range",
            "from": "0",
            "to": "9"
          }
        },
        "sep": {
          "type": "Text",
          "value": ""
        }
      }
    ]
  },
  "object": {
    "type": "Sequence",
    "items": [
      {
        "type": "Text",
        "value": "{"
      },
      {
        "type": "RepSep",
        "rep": {
          "type": "Ref",
          "rule": "keyValue",
          "captureName": null
        },
        "sep": {
          "type": "Text",
          "value": ","
        }
      },
      {
        "type": "Text",
        "value": "}"
      }
    ]
  },
  "keyValue": {
    "type": "Sequence",
    "items": [
      {
        "type": "Ref",
        "rule": "string",
        "captureName": null
      },
      {
        "type": "Text",
        "value": ":"
      },
      {
        "type": "Ref",
        "rule": "value",
        "captureName": null
      }
    ]
  },
  "array": {
    "type": "Sequence",
    "items": [
      {
        "type": "Text",
        "value": "["
      },
      {
        "type": "RepSep",
        "rep": {
          "type": "Ref",
          "rule": "value",
          "captureName": null
        },
        "sep": {
          "type": "Text",
          "value": ","
        }
      },
      {
        "type": "Text",
        "value": "]"
      }
    ]
  },
  "null": {
    "type": "Text",
    "value": "null"
  },
  "string": {
    "type": "Sequence",
    "items": [
      {
        "type": "Text",
        "value": "\""
      },
      {
        "type": "RepSep",
        "rep": {
          "type": "Ref",
          "rule": "stringChar",
          "captureName": null
        },
        "sep": {
          "type": "Text",
          "value": ""
        }
      },
      {
        "type": "Text",
        "value": "\""
      }
    ]
  },
  "stringChar": {
    "type": "Choice",
    "choices": [
      {
        "type": "Char",
        "rule": {
          "type": "Not",
          "rule": {
            "type": "Literal",
            "value": "\""
          }
        }
      },
      {
        "type": "Sequence",
        "items": [
          {
            "type": "Char",
            "rule": {
              "type": "Literal",
              "value": "\\"
            }
          },
          {
            "type": "Char",
            "rule": {
              "type": "Literal",
              "value": "\""
            }
          }
        ]
      }
    ]
  }
}
