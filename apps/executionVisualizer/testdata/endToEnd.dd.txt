countUp {
  x = 0;
  goto loop;
}
loop {
  threshold = 5;
  x = prim.incr(x);
  going = prim.lt(x, threshold);
  goto loop if going;
}
state.Var{var: "x"}?
----
application/datalog
state.Var{thread: 1, time: 10, value: 2, var: "x"}.
state.Var{thread: 1, time: 11, value: 2, var: "x"}.
state.Var{thread: 1, time: 12, value: 2, var: "x"}.
state.Var{thread: 1, time: 13, value: 3, var: "x"}.
state.Var{thread: 1, time: 14, value: 3, var: "x"}.
state.Var{thread: 1, time: 15, value: 3, var: "x"}.
state.Var{thread: 1, time: 16, value: 3, var: "x"}.
state.Var{thread: 1, time: 17, value: 4, var: "x"}.
state.Var{thread: 1, time: 18, value: 4, var: "x"}.
state.Var{thread: 1, time: 19, value: 4, var: "x"}.
state.Var{thread: 1, time: 2, value: 0, var: "x"}.
state.Var{thread: 1, time: 20, value: 4, var: "x"}.
state.Var{thread: 1, time: 21, value: 5, var: "x"}.
state.Var{thread: 1, time: 22, value: 5, var: "x"}.
state.Var{thread: 1, time: 23, value: 5, var: "x"}.
state.Var{thread: 1, time: 3, value: 0, var: "x"}.
state.Var{thread: 1, time: 4, value: 0, var: "x"}.
state.Var{thread: 1, time: 5, value: 1, var: "x"}.
state.Var{thread: 1, time: 6, value: 1, var: "x"}.
state.Var{thread: 1, time: 7, value: 1, var: "x"}.
state.Var{thread: 1, time: 8, value: 1, var: "x"}.
state.Var{thread: 1, time: 9, value: 2, var: "x"}.

countUp {
  x = 0;
  goto loop;
}
loop {
  forked = fork();
  goto afterFork if forked;
  x = prim.incr(x);
  threshold = 5;
  going = prim.lt(x, threshold);
  goto loop if going;
}
afterFork {
  done = 42;
}
state.ProgramCounter{}?
----
application/datalog
state.ProgramCounter{counter: 0, state: running{}, thread: 1, time: 1}.
state.ProgramCounter{counter: 1, state: running{}, thread: 1, time: 2}.
state.ProgramCounter{counter: 2, state: running{}, thread: 1, time: 15}.
state.ProgramCounter{counter: 2, state: running{}, thread: 1, time: 21}.
state.ProgramCounter{counter: 2, state: running{}, thread: 1, time: 27}.
state.ProgramCounter{counter: 2, state: running{}, thread: 1, time: 3}.
state.ProgramCounter{counter: 2, state: running{}, thread: 1, time: 9}.
state.ProgramCounter{counter: 3, state: running{}, thread: 1, time: 10}.
state.ProgramCounter{counter: 3, state: running{}, thread: 1, time: 16}.
state.ProgramCounter{counter: 3, state: running{}, thread: 1, time: 22}.
state.ProgramCounter{counter: 3, state: running{}, thread: 1, time: 28}.
state.ProgramCounter{counter: 3, state: running{}, thread: 1, time: 4}.
state.ProgramCounter{counter: 3, state: running{}, thread: 105, time: 4}.
state.ProgramCounter{counter: 3, state: running{}, thread: 111, time: 10}.
state.ProgramCounter{counter: 3, state: running{}, thread: 117, time: 16}.
state.ProgramCounter{counter: 3, state: running{}, thread: 123, time: 22}.
state.ProgramCounter{counter: 3, state: running{}, thread: 129, time: 28}.
state.ProgramCounter{counter: 4, state: running{}, thread: 1, time: 11}.
state.ProgramCounter{counter: 4, state: running{}, thread: 1, time: 17}.
state.ProgramCounter{counter: 4, state: running{}, thread: 1, time: 23}.
state.ProgramCounter{counter: 4, state: running{}, thread: 1, time: 29}.
state.ProgramCounter{counter: 4, state: running{}, thread: 1, time: 5}.
state.ProgramCounter{counter: 5, state: running{}, thread: 1, time: 12}.
state.ProgramCounter{counter: 5, state: running{}, thread: 1, time: 18}.
state.ProgramCounter{counter: 5, state: running{}, thread: 1, time: 24}.
state.ProgramCounter{counter: 5, state: running{}, thread: 1, time: 30}.
state.ProgramCounter{counter: 5, state: running{}, thread: 1, time: 6}.
state.ProgramCounter{counter: 6, state: running{}, thread: 1, time: 13}.
state.ProgramCounter{counter: 6, state: running{}, thread: 1, time: 19}.
state.ProgramCounter{counter: 6, state: running{}, thread: 1, time: 25}.
state.ProgramCounter{counter: 6, state: running{}, thread: 1, time: 7}.
state.ProgramCounter{counter: 7, state: running{}, thread: 1, time: 14}.
state.ProgramCounter{counter: 7, state: running{}, thread: 1, time: 20}.
state.ProgramCounter{counter: 7, state: running{}, thread: 1, time: 26}.
state.ProgramCounter{counter: 7, state: running{}, thread: 1, time: 8}.
state.ProgramCounter{counter: 8, state: running{}, thread: 105, time: 5}.
state.ProgramCounter{counter: 8, state: running{}, thread: 111, time: 11}.
state.ProgramCounter{counter: 8, state: running{}, thread: 117, time: 17}.
state.ProgramCounter{counter: 8, state: running{}, thread: 123, time: 23}.
state.ProgramCounter{counter: 8, state: running{}, thread: 129, time: 29}.
state.ProgramCounter{counter: 9, state: running{}, thread: 105, time: 6}.
state.ProgramCounter{counter: 9, state: running{}, thread: 111, time: 12}.
state.ProgramCounter{counter: 9, state: running{}, thread: 117, time: 18}.
state.ProgramCounter{counter: 9, state: running{}, thread: 123, time: 24}.
state.ProgramCounter{counter: 9, state: running{}, thread: 129, time: 30}.

main {
  x = 5;
  y = block.sleep(x);
  z = 10;
}
state.ProgramCounter{}?
----
application/datalog
state.ProgramCounter{counter: 0, state: running{}, thread: 1, time: 1}.
state.ProgramCounter{counter: 1, state: running{}, thread: 1, time: 2}.
state.ProgramCounter{counter: 2, state: blocked{reason: timer{start: 3, thread: 1}}, thread: 1, time: 3}.
state.ProgramCounter{counter: 2, state: blocked{reason: timer{start: 3, thread: 1}}, thread: 1, time: 4}.
state.ProgramCounter{counter: 2, state: blocked{reason: timer{start: 3, thread: 1}}, thread: 1, time: 5}.
state.ProgramCounter{counter: 2, state: blocked{reason: timer{start: 3, thread: 1}}, thread: 1, time: 6}.
state.ProgramCounter{counter: 2, state: blocked{reason: timer{start: 3, thread: 1}}, thread: 1, time: 7}.
state.ProgramCounter{counter: 2, state: running{}, thread: 1, time: 8}.
state.ProgramCounter{counter: 3, state: running{}, thread: 1, time: 9}.

main {
  x = 5;
  y = block.sleep(x);
  z = 10;
}
state.Timer{}?
----
application/datalog
state.Timer{startTime: 3, thread: 1, wakeupTime: 8}.

countUp {
  x = 0;
  goto loop;
}
loop {
  forked = fork();
  goto afterFork if forked;
  x = prim.incr(x);
  threshold = 5;
  going = prim.lt(x, threshold);
  goto loop if going;
}
afterFork {
  x = 5;
  y = block.sleep(x);
  z = 10;
}
state.Timer{}?
----
application/datalog
state.Timer{startTime: 13, thread: 111, wakeupTime: 18}.
state.Timer{startTime: 19, thread: 117, wakeupTime: 24}.
state.Timer{startTime: 25, thread: 123, wakeupTime: 30}.
state.Timer{startTime: 7, thread: 105, wakeupTime: 12}.

main {
  lock1 = prim.newLock(); // TODO: generic "new" instr?
  lock2 = prim.newLock();
  forked = fork();
  goto afterFork if forked;
  // TODO: allow calls without result vars
  x1 = block.acquireLock(lock1);
  x2 = block.acquireLock(lock2);
  x3 = releaseLock(lock1);
  x4 = releaseLock(lock2);
}
afterFork {
  x5 = block.acquireLock(lock2);
  x6 = block.acquireLock(lock1);
  x7 = releaseLock(lock2);
  x8 = releaseLock(lock1);
}
state.var.store.call.newLock{}?
----
application/datalog
state.var.store.call.newLock{thread: 1, time: 2, value: lock{created: point{thread: 1, time: T}}, var: "lock1"}.
state.var.store.call.newLock{thread: 1, time: 3, value: lock{created: point{thread: 1, time: T}}, var: "lock2"}.
